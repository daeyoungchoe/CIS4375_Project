"use strict";var fs=require("fs"),Promise=require("bluebird"),Mustache=require("mustache"),path=require("path"),cookie=require("cookie"),sessions=require("client-sessions"),decode=require("urldecode"),SESSION_COOKIE_NAME="vertexSession",shouldClearSession=!1,proxyVertexSession=function(e,r){var n={set:function(n,t,s){n==e&&(r.vertexSessionChanged=!0,n[t]=s)}};return new Proxy(e,n)},readFile=function(e){return new Promise(function(r,n){fs.readFile(e,"utf8",function(t,s){if(t)return void n(new Error("File Not Found: "+e));r(s)})})},readDirectory=function(e){return new Promise(function(r,n){fs.readdir(e,function(e,t){if(e)return void n(e);r(t)})})},renderMustache=function(e){return new Promise(function(r,n){var t=e.template;if(null==t)return void n(new Error("Missing template"));var s=e.data;if(null==s)return void n(new Error("Missing data"));var i=e.partials||{};try{var o=s||{};r(Mustache.render(t,o,i))}catch(e){n(e)}})},getCookieName=function(e){var r=SESSION_COOKIE_NAME;return null!=e&&null!=e.session&&(r=e.session.cookieName||SESSION_COOKIE_NAME),r},setVertexSession=function(e,r,n){var t=getCookieName(n);if(1==shouldClearSession)return r["Set-Cookie"]=t+"=deleted; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT",shouldClearSession=!1,r;if(0==e.vertexSessionChanged)return r;var s=e[t]||{};if(delete s.reset,0==Object.keys(s).length)return r;var i=JSON.stringify(s),o=sessions.util.encode({cookieName:t,secret:"abc"},i,null,null);return r["Set-Cookie"]=t+"="+o+"; path=/;",r},configureResponse=function(e,r,n){var t="views";return null!=n&&(t=n.views||"views"),{statusCode:200,setHeader:function(e,r){({})[e]=r},json:function(t){var s={"Content-Type":"application/json"};r(null,{isBase64Encoded:!1,statusCode:200,headers:setVertexSession(e,s,n),headers:s,body:JSON.stringify(t)})},send:function(t){var s={"Content-Type":"text/plain"};r(null,{isBase64Encoded:!1,statusCode:200,headers:setVertexSession(e,s,n),headers:s,body:t})},redirect:function(t){var s={Location:t};r(null,{isBase64Encoded:!1,statusCode:301,headers:setVertexSession(e,s,n),headers:s,body:t})},render:function(s,i){var o=i||{},a=__dirname.replace("node_modules/vertex360/dist/vertex",""),u=a+"/"+t+"/"+s+".mustache",c={},s=null;readFile(u).then(function(e){return s=e,readDirectory(a+"/"+t+"/partials")}).then(function(e){return e.forEach(function(e,r){e.indexOf(".mustache")>-1&&(c[e.split(".")[0]]=fs.readFileSync(a+"/"+t+"/partials/"+e,"utf8"))}),renderMustache({template:s,data:o,partials:c})}).then(function(t){r(null,{isBase64Encoded:!1,statusCode:200,headers:setVertexSession(e,{"Content-Type":"text/html"},n),body:t})}).catch(function(e){r(null,{isBase64Encoded:!1,statusCode:404,headers:{"Content-Type":"application/json"},body:JSON.stringify({confirmation:"fail",message:e.message})})})}}},clearSession=function(){shouldClearSession=!0},bindMiddleware=function(e,r,n){return new Promise(function(t,s){if(null==n)return void t({req:e,res:r});if(0==n.length)return void t({req:e,res:r});var i=0,o=function(){if(!(i<n.length))return void t({req:e,res:r});(0,n[i])(e,r,function(){i+=1,o()})};o()})};module.exports=function(e,r,n,t,s,i){var o={};if(null!=e.body)try{o=JSON.parse(e.body)}catch(r){var a=e.body.split("&");a.forEach(function(e,r){var n=e.split("=");2==n.length&&(o[n[0]]=decode(n[1]))})}var u=e.path,c=e.queryStringParameters||{},d=Object.keys(c);d.length>0&&(u+="?",d.forEach(function(e,r){c[e]&&(u+=e+"="+c[e])}));var l={query:c,body:o,headers:e.headers,vertexSessionChanged:!1,method:e.httpMethod.toUpperCase(),url:u},f=getCookieName(t),h={reset:clearSession};l[f]=proxyVertexSession(h,l),null!=n&&(l.params=n.params);var v=e.headers.Cookie;if(null==v){var p=configureResponse(l,r,t);return void bindMiddleware(l,p,s).then(function(e){return i(null,{req:e.req,res:e.res})}).catch(function(e){reject(e)})}var S=cookie.parse(v);if(null==S[f]){var p=configureResponse(l,r,t);return void bindMiddleware(l,p,s).then(function(e){return i(null,{req:e.req,res:e.res})}).catch(function(e){reject(e)})}try{var y=sessions.util.decode({cookieName:f,secret:"abc"},S[f]);if(null==y){var m=configureResponse(l,r,t);return void bindMiddleware(l,m,s).then(function(e){return i(null,{req:e.req,res:e.res})}).catch(function(e){reject(e)})}if(null==y.content){var C=configureResponse(l,r,t);return void bindMiddleware(l,C,s).then(function(e){return i(null,{req:e.req,res:e.res})}).catch(function(e){reject(e)})}var h=JSON.parse(y.content);h.reset=clearSession,l[f]=proxyVertexSession(h,l);var p=configureResponse(l,r,t);bindMiddleware(l,p,s).then(function(e){return i(null,{req:e.req,res:e.res})}).catch(function(e){reject(e)})}catch(e){l[f]=S[f];var p=configureResponse(l,r,t);bindMiddleware(l,p,s).then(function(e){return i(null,{req:e.req,res:e.res})}).catch(function(e){reject(e)})}};