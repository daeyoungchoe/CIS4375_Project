"use strict";var _prototypeProperties=function(e,t,r){t&&Object.defineProperties(e,t),r&&Object.defineProperties(e.prototype,r)},_classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},formatCallback=require("./callback"),Router=require("./Router"),db=require("./db"),generateErrorCallback=function(e,t){return{isBase64Encoded:!1,statusCode:t,headers:{"Content-Type":"application/json"},body:JSON.stringify({confirmation:"fail",data:{message:e.message,stack:e.stack}})}},Vertex=function(){function e(t){if(_classCallCheck(this,e),this.routes=[],this.middleware=[],this.staticDir="public",this.opts=t,null!=t){this.staticDir=t.static||"public";var r=t.db;null!=r&&(null==r.type?db.connect(r.url,r.onError,r.onSuccess):(r.type,db.connectMongo(r.url,r.onError,r.onSuccess)))}}return _prototypeProperties(e,null,{expressVersion:{value:function(e){var t=this;return e.use("/turbo",function(e,r,o){r.json({confirmation:"success",data:JSON.stringify(t.routes)})}),t.routes.forEach(function(t){e.use(t.stem,function(e,r,o){r.json({confirmation:"success",data:t.stem})})}),e},writable:!0,configurable:!0},useStatic:{value:function(e){this.staticDir=e},writable:!0,configurable:!0},use:{value:function(e,t){if(null==t)return void this.middleware.push(e);t.setStem(e),this.routes.push(t)},writable:!0,configurable:!0},get:{value:function(e,t){var r=new Router;r.setStem("/"),r.get(e,t),this.routes.push(r)},writable:!0,configurable:!0},post:{value:function(e,t){var r=new Router;r.setStem("/"),r.post(e,t),this.routes.push(r)},writable:!0,configurable:!0},routeNotFound:{value:function(e,t){e.httpMethod.toLowerCase();return{isBase64Encoded:!1,statusCode:501,headers:{"Content-Type":"application/json"},body:JSON.stringify({confirmation:"fail",message:t})}},writable:!0,configurable:!0},handle:{value:function(e){var t=this,r=e.event,o=e.callback,n=r.httpMethod.toLowerCase();if("post"==n){var a=function(){for(var e=null,a=0;a<t.routes.length;a++){var i=t.routes[a];if(null!=i.handlePost(r)){e=i.handlePost(r);break}}return null==e?(o(null,t.routeNotFound(r,n+" route not defined for this path: "+r.path)),{v:void 0}):(formatCallback(r,o,e.routeParams,t.opts,t.middleware,function(t,r){if(null!=t)return void o(null,generateErrorCallback(t,500));try{e.routeHandler(r.req,r.res)}catch(t){return void o(null,generateErrorCallback(t,500))}}),{v:void 0})}();if("object"==typeof a)return a.v}if("put"==n){var i=function(){for(var e=null,a=0;a<t.routes.length;a++){var i=t.routes[a];if(null!=i.handlePut(r)){e=i.handlePut(r);break}}return null==e?(o(null,t.routeNotFound(r,n+" route not defined for this path: "+r.path)),{v:void 0}):(formatCallback(r,o,e.routeParams,t.opts,t.middleware,function(t,r){if(null!=t)return void o(null,generateErrorCallback(t,500));try{e.routeHandler(r.req,r.res)}catch(t){return void o(null,generateErrorCallback(t,500))}}),{v:void 0})}();if("object"==typeof i)return i.v}if("delete"==n){var l=function(){for(var e=null,a=0;a<t.routes.length;a++){var i=t.routes[a];if(null!=i.handleDelete(r)){e=i.handleDelete(r);break}}return null==e?(o(null,t.routeNotFound(r,n+" route not defined for this path: "+r.path)),{v:void 0}):(formatCallback(r,o,e.routeParams,t.opts,t.middleware,function(t,r){if(null!=t)return void o(null,generateErrorCallback(t,500));try{e.routeHandler(r.req,r.res)}catch(t){return void o(null,generateErrorCallback(t,500))}}),{v:void 0})}();if("object"==typeof l)return l.v}if("get"==n){if(-1==r.path.indexOf(".")){var u=function(){for(var e=null,a=0;a<t.routes.length;a++){var i=t.routes[a];if(null!=i.handleGet(r)){e=i.handleGet(r);break}}return null==e?(o(null,t.routeNotFound(r,n+" route not defined for this path: "+r.path)),{v:void 0}):(formatCallback(r,o,e.routeParams,t.opts,t.middleware,function(t,r){if(null!=t)return void o(null,generateErrorCallback(t,500));try{e.routeHandler(r.req,r.res)}catch(t){return void o(null,generateErrorCallback(t,500))}}),{v:void 0})}();if("object"==typeof u)return u.v}if(void 0==r.headers||null==r.headers)return void o(null,{isBase64Encoded:!1,statusCode:500,headers:{"Content-Type":"application/json"},body:JSON.stringify({confirmation:"fail",data:"Missing Turbo-Vertex-App header (headers is null)"})});var s=r.headers["Turbo-Vertex-App"],c=this.staticDir||"public",d=null;if(null==this.opts){if(null==s)return void o(null,{isBase64Encoded:!1,statusCode:500,headers:{"Content-Type":"application/json"},body:JSON.stringify({confirmation:"fail",data:"Missing Turbo-Vertex-App header"})});var f="cdn.turbo360-vertex.com/"+s+"/"+c+r.path;d=f.replace("//","/")}else if(null==this.opts.bucket){if(null==s)return void o(null,{isBase64Encoded:!1,statusCode:500,headers:{"Content-Type":"application/json"},body:JSON.stringify({confirmation:"fail",data:"Missing Turbo-Vertex-App header"})});var f="cdn.turbo360-vertex.com/"+s+"/"+c+r.path;d=f.replace("//","/")}else d="s3.amazonaws.com/"+this.opts.bucket+"/"+c+r.path;o(null,{isBase64Encoded:!1,statusCode:301,headers:{Location:"https://"+d},body:""})}},writable:!0,configurable:!0}}),e}();module.exports=Vertex;