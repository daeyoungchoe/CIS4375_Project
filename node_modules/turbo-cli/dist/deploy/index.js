var shell=require("shelljs"),colors=require("colors/safe"),readdirp=require("readdirp"),base64=require("js-base64"),awsClient=require("../aws"),utils=require("../utils"),path=require("path"),dotenv=require("dotenv"),bestzip=require("bestzip"),BASE_URL="https://www.turbo360.co",REGIONS={"us-east-1":"US East (Northern Virginia)","us-west-2":"US West (Oregon)","us-west-1":"US West (Northern California)","eu-west-1":"EU (Ireland)","ap-southeast-1":"Asia Pacific (Singapore)","ap-northeast-1":"Asia Pacific (Tokyo)","sa-east-1":"South America (Sao Paulo)"},zipDirectory=function(){return process.platform,bestzip.nodeZip({source:"*",destination:"../package.zip"})},configureUploader=function(e,n){return awsClient.s3sync(null,e).on("data",function(e){shell.echo("-n",".")}).once("end",n)},deployComplete=function(e,n,o){utils.readFile("package.json").then(function(o){var t=JSON.parse(o),r={id:e.id,name:e.name,image:e.image,slug:e.slug,origin:e.origin,format:t.format||"vertex"};t["vtx-template"]&&(r["vtx-template"]=t["vtx-template"]);var l={environment:n,site:r};return utils.postRequest("https://platform.turbo360-vector.com/deploycomplete",l)}).then(function(e){}).catch(function(e){})},compile=function(e,n,o,t){return new Promise(function(e,n){var o=null,r={};utils.readFile("package.json").then(function(e){return o=JSON.parse(e),utils.readFile(".env")}).then(function(e){if(r=dotenv.parse(e),null==r.SESSION_SECRET)throw new Error("Please include a SESSION_SECRET environment variable in the .env file.");r.TURBO_ENV="prod";var n=(Object.keys(o.dependencies),Object.assign({},o.devDependencies));return delete o.devDependencies,shell.mkdir("-p",t+"/"),shell.cp("-R","!(node_modules|deploy)",t+"/"),utils.write("./"+t+"/package.json",JSON.stringify(o,null,2)+"\n"),shell.cd(t),shell.mkdir("-p","www"),shell.cp("-R",path.join(__dirname,"../default/vertex/www/bin.js"),"www/bin.js"),shell.exec("npm install --silent --no-progress"),shell.cd(".."),o.devDependencies=n,utils.write("./"+t+"/package.json",JSON.stringify(o,null,2)+"\n"),shell.cd(t),zipDirectory()}).then(function(){shell.cd(".."),shell.mv(["package.zip"],t+"/"),shell.cd(t),shell.rm("-rf","node_modules"),shell.rm("-rf","www"),e(r)}).catch(function(e){console.log("COMPILE ERROR: "+e.message),n(e)})})};module.exports={build:function(e,n,o){console.log("\n\nGenerating package.zip file...\n"),compile(e,n,o,".deploy").then(function(e){shell.mv(["package.zip"],".."),shell.cd(".."),shell.rm("-rf",".deploy"),console.log("\n\n* * * Build complete. Check current directory for package.zip file. * * *\n\n")}).catch(function(e){var n=colors.red("\n\nERROR: "+e.message+"\n\n");console.log(n)})},deployToVertex:function(e,n,o){var t=o.slug+"/",r={};console.log(colors.cyan("\n\nDeploying to Turbo 360 Hosting Environment...\n")),compile(e,n,o,".deploy").then(function(l){r=l,shell.cd("..");var i=function(){shell.rm("-rf",".deploy");var n=t.split("/")[0],l={name:n,path:n+"/package.zip",env:r};utils.postRequest("https://platform.turbo360-vector.com/resetfunction",{lambda:l}).then(function(n){console.log(colors.cyan("\n\nDEPLOY COMPLETE!\nStaging URL: https://"+l.name+".turbo360-vertex.com\n")),deployComplete(o,"production",e)}).catch(function(e){var n=colors.red("\n\nERROR: "+e.message+"\n\n");console.log(n)})},s=e.split("::"),c=configureUploader({key:s[0],secret:s[1],bucket:n,concurrency:16,prefix:t},i);readdirp({root:".deploy"}).pipe(c)}).catch(function(e){var n=colors.red("\n\nERROR: "+e.message+"\n\n");console.log(n)})},deployToCustom:function(e,n,o){var t=o.slug+"/",r={},l=n.account,i=n.role,s=n.bucket,c=n.region;if(!REGIONS[c]){var a='\nInvalid Region "'+c+'", please select from the list below:\n\n';throw Object.keys(REGIONS).forEach(function(e){a+=e+"\n"}),new Error(a)}console.log(colors.cyan("\n\nDeploying to Custom Hosting Environment...\n")),compile(e,s,o,".deploy").then(function(n){r=n,shell.cd("..");var a=function(){shell.rm("-rf",".deploy");var n=o.slug,t={config:e,name:n,path:n+"/package.zip",env:r,bucket:s,region:c,role:"arn:aws:iam::"+l+":role/"+i};awsClient.getFunction(t).then(function(e){return null==e?null:awsClient.deleteFunction(t)}).then(function(o){return awsClient.deleteObject({Bucket:s,Key:n+"/"},e)}).then(function(e){return awsClient.deployVertex(t)}).then(function(o){return console.log(colors.cyan("\n\nDEPLOY COMPLETE!\nStaging URL: https://"+n+".turbo360-proxy.com\n")),awsClient.addPermissions({config:e,name:o.FunctionArn})}).then(function(e){const n={appid:o.id,appslug:o.slug,account:l,region:c};return utils.postRequest("https://platform.turbo360-vector.com/register-delegate",n)}).then(function(e){}).catch(function(e){console.log(colors.red("\nERROR: "+e.message+"\n"))})},u=e.split("::"),p=configureUploader({key:u[0],secret:u[1],bucket:s,region:c,concurrency:16,prefix:t},a);readdirp({root:".deploy"}).pipe(p)}).catch(function(e){console.log(e.message)})}};