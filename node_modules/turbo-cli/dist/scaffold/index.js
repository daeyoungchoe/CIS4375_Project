var program=require("commander"),shell=require("shelljs"),path=require("path"),fs=require("fs"),utils=require("../utils"),reactDependencies=require("../default/packagejson/react.json"),dotenv=require("dotenv"),colors=require("colors/safe"),PLATFORM_VECTOR_URL="https://platform.turbo360-vector.com",VERTEX_NPM_VERSION="^0.30.25",TURBO_NPM_VERSION="^1.8.69",nextSteps=function(e){console.log("\n- - - - - Next Steps - - - - - "),console.log("1. $ cd "+e),console.log("2. $ npm install"),console.log("3. $ turbo devserver"),console.log("4. Open http://localhost:3000 in a browser"),console.log("- - - - - - - - - - - - - - - - -\n"),console.log("For full documentation, visit https://docs.turbo360.co\n")},importVectors=function(e){e.mkdir("-p","vectors"),e.mkdir("-p","vectors/js"),e.mkdir("-p","vectors/py"),e.cp("-R",path.join(__dirname,"../default/lambda/js/index.js"),"vectors/js/index.js"),e.cp("-R",path.join(__dirname,"../default/lambda/py/requirements.txt"),"vectors/py/requirements.txt"),e.cp("-R",path.join(__dirname,"../default/lambda/py/app.py"),"vectors/py/app.py")},currentConfig=function(e){null==e&&(e="vertex");var t=null;return"vertex"==e&&(t="vertex-package.json"),new Promise(function(e,r){utils.getRequest("https://cdn.turbo360-dev.com/dist/config/"+t,null).then(function(t){if("success"!=t.confirmation)throw new Error("");e(t.data)}).catch(function(t){e({vertexVersion:VERTEX_NPM_VERSION,turboVersion:TURBO_NPM_VERSION})})})};module.exports=function(e,t,r,i){var n=process.platform;if("fullstack"==r||"server"==r)return void console.log("The "+r+" scaffold option has been deprected. Please use --vertex instead.");if("vertex"==r)return void currentConfig("vertex").then(function(r){r.vertexVersion!=VERTEX_NPM_VERSION&&(VERTEX_NPM_VERSION=r.vertexVersion),r.turboVersion!=TURBO_NPM_VERSION&&(TURBO_NPM_VERSION=r.turboVersion),e.cp("-R",path.join(__dirname,"../default/vertex/gitignore.txt"),".gitignore"),e.cp("-R",path.join(__dirname,"../default/vertex/env.txt"),".env"),e.cp("-R",path.join(__dirname,"../default/vertex/app.js"),"app.js"),e.cp("-R",path.join(__dirname,"../default/vertex/README.md"),"README.md"),e.mkdir("-p","bin"),e.cp("-R",path.join(__dirname,"../default/vertex/bin/*"),"bin/"),e.mkdir("-p","routes"),e.cp("-R",path.join(__dirname,"../default/vertex/routes/*"),"routes/"),e.mkdir("-p","views"),e.cp("-R",path.join(__dirname,"../default/vertex/views/index.mustache"),"views/index.mustache"),e.cd("views"),e.cd(".."),e.mkdir("-p","public"),e.mkdir("-p","public/css"),e.cp("-R",path.join(__dirname,"../default/vertex/public/css/*"),"public/css/"),e.mkdir("-p","public/images"),e.cp("-R",path.join(__dirname,"../default/vertex/public/images/turbo.png"),"public/images/turbo.png"),e.mkdir("-p","public/js"),e.cp("-R",path.join(__dirname,"../default/vertex/public/js/*"),"public/js/");var i=r.scripts||{start:"node ./bin/www",test:"",build:"",postinstall:"turbo postinstall"},n=r.devDependencies||{nodemon:"^2.0.1",rimraf:"^2.6.2"},s=r.dependencies||{turbo360:TURBO_NPM_VERSION,vertex360:VERTEX_NPM_VERSION,"content-type":"^1.0.4","cookie-signature":"1.0.6","escape-html":"^1.0.3",express:"^4.17.1",finalhandler:"1.1.1",fresh:"0.5.2","merge-descriptors":"1.0.1",methods:"^1.1.2","on-finished":"^2.3.0",parseurl:"^1.3.2","path-to-regexp":"0.1.7","proxy-addr":"^2.0.3",qs:"6.5.1","range-parser":"^1.2.0","safe-buffer":"5.1.1",send:"0.16.2","serve-static":"1.13.2",setprototypeof:"1.1.0",statuses:"^1.4.0","type-is":"^1.6.16","utils-merge":"1.0.1",vary:"^1.1.2"},a={name:t,version:"0.0.0",server:!1,private:!0,scripts:i,dependencies:s,devDependencies:n,format:"vertex"};return utils.write("package.json",JSON.stringify(a,null,2)+"\n"),utils.readFile("README.md")}).then(function(e){null!=e&&(e=e.replace("{{title}}",t),utils.write("README.md",e+"\n")),nextSteps(t)}).catch(function(e){});if("react"==r){e.cp("-R",path.join(__dirname,"../default/vertex/gitignore.txt"),".gitignore"),e.cp("-R",path.join(__dirname,"../default/vertex/env.txt"),".env"),e.cp("-R",path.join(__dirname,"../default/vertex/app.js"),"app.js"),e.cp("-R",path.join(__dirname,"../default/vertex/README.md"),"README.md"),e.cp("-R",path.join(__dirname,"../default/vertex/webpack.config.js"),"webpack.config.js"),e.cp("-R",path.join(__dirname,"../default/vertex/gulpfile.js"),"gulpfile.js"),e.mkdir("-p","bin"),e.cp("-R",path.join(__dirname,"../default/vertex/bin/*"),"bin/"),e.mkdir("-p","routes"),e.cp("-R",path.join(__dirname,"../default/vertex/routes/*"),"routes/"),e.mkdir("-p","views"),e.cp("-R",path.join(__dirname,"../default/vertex/views/react.mustache"),"views/index.mustache"),e.cd("views"),e.mkdir("-p","partials"),e.cd(".."),e.cp("-R",path.join(__dirname,"../default/vertex/views/partials/head.mustache"),"views/partials/head.mustache"),e.mkdir("-p","public"),e.mkdir("-p","public/css"),e.cp("-R",path.join(__dirname,"../default/vertex/public/css/*"),"public/css/"),e.mkdir("-p","public/images"),e.cp("-R",path.join(__dirname,"../default/vertex/public/images/*"),"public/images/"),e.mkdir("-p","public/js"),e.cp("-R",path.join(__dirname,"../default/vertex/public/js/*"),"public/js/"),e.mkdir("-p","src"),e.cp("-R",path.join(__dirname,"../default/client/src/*"),"src/");var s={start:"node ./bin/www",dev:"webpack --mode development -w",build:"npm run clean && NODE_ENV=production webpack -p && gulp prod",clean:"rm -rf ./public/dist",postinstall:"npm run build"};"win32"==n&&(s.clean="rimraf ./public/dist",s.build="npm run clean && cross-env NODE_ENV=production webpack -p && gulp prod");var a={turbo360:TURBO_NPM_VERSION,vertex360:VERTEX_NPM_VERSION,debug:"^3.1.0",dotenv:"^5.0.1",moment:"^2.20.1",superagent:"^3.8.2",accepts:"^1.3.5","body-parser":"1.18.2","content-type":"^1.0.4",cookie:"0.3.1","cookie-signature":"1.0.6",debug:"2.6.9",depd:"^1.1.2","escape-html":"^1.0.3",finalhandler:"1.1.1",fresh:"0.5.2","merge-descriptors":"1.0.1",methods:"^1.1.2","on-finished":"^2.3.0",parseurl:"^1.3.2","path-to-regexp":"0.1.7","proxy-addr":"^2.0.3",qs:"6.5.1","range-parser":"^1.2.0","safe-buffer":"5.1.1",send:"0.16.2","serve-static":"1.13.2",setprototypeof:"1.1.0",statuses:"^1.4.0","type-is":"^1.6.16","utils-merge":"1.0.1",vary:"^1.1.2"};reactDependencies.dependencies.forEach(function(e){var t=e.split("@");2==t.length&&(a[t[0]]="^"+t[1])});var o={chai:"^4.1.2","chai-http":"^3.0.0",mocha:"^5.0.1","mocha-jscs":"^5.0.1","mocha-jshint":"^2.3.1",nodemon:"^2.0.1",rimraf:"^2.6.2"};reactDependencies.devDependencies.forEach(function(e){var t=e.split("@");2==t.length&&(o[t[0]]="^"+t[1])});var p={name:t,version:"0.0.0",server:!1,private:!0,scripts:s,dependencies:a,devDependencies:o,format:"vertex",app:""};utils.write("package.json",JSON.stringify(p,null,2)+"\n"),utils.readFile("README.md").then(function(e){null!=e&&(e=e.replace("{{title}}",t),utils.write("README.md",e+"\n")),nextSteps(t)}).catch(function(e){})}if("template"==r){if(null==i){e.mkdir("-p","models");var l=fs.existsSync(path.join(__dirname,"../template/"+t+"/models"));l&&e.cp("-R",path.join(__dirname,"../template/"+t+"/models/*"),"models/"),e.mkdir("-p","controllers"),e.cp("-R",path.join(__dirname,"../template/"+t+"/controllers/*"),"controllers/");var c=require("../template/"+t+"/shared");c.forEach(function(t){e.cp("-R",path.join(__dirname,"../template/shared/controllers/"+t+"Controller.js"),"controllers/"),e.cp("-R",path.join(__dirname,"../template/shared/models/"+t+".js"),"models/")}),e.cp("-R",path.join(__dirname,"../template/shared/routes/sample.js"),"routes/"),e.mkdir("-p","tmp");var d=fs.readdirSync("models");return e.cd("tmp"),d.forEach(function(e){var t=e.replace(".js","").toLowerCase()+"s";utils.write(t+".db","")}),e.cd(".."),void utils.readFile(".env").then(function(e){if(null!=e){var t=dotenv.parse(e);t.TMP_DIR="/tmp";["TURBO_API_KEY","TURBO_APP_ID","TURBO_APP_SLUG","SESSION_SECRET"].forEach(function(e){null==t[e]&&(t[e]="<"+e+">")});var r="";return Object.keys(t).forEach(function(e,i){null!=t[e]&&(r+=e+"="+t[e]+"\n")}),utils.write(".env",r),utils.readFile("package.json")}}).then(function(e){var t=JSON.parse(e);t.scripts.reset="rimraf ./tmp/*",utils.write("package.json",JSON.stringify(t,null,2)+"\n"),console.log(colors.cyan("Template successfully configured.\n"))}).catch(function(e){console.log("ERROR - "+e.message)})}e.cp("-R",path.join(__dirname,"../default/vertex/gitignore.txt"),".gitignore"),e.cp("-R",path.join(__dirname,"../default/vertex/README.md"),"README.md"),e.mkdir("-p","bin"),e.cp("-R",path.join(__dirname,"../default/vertex/bin/*"),"bin/"),e.cp("-R",path.join(__dirname,"../template/shared/env.txt"),".env"),e.mkdir("-p","routes"),e.cp("-R",path.join(__dirname,"../template/shared/routes/sample.js"),"routes/"),e.mkdir("-p","models");var l=fs.existsSync(path.join(__dirname,"../template/"+t+"/models"));l&&e.cp("-R",path.join(__dirname,"../template/"+t+"/models/*"),"models/"),e.mkdir("-p","controllers"),e.cp("-R",path.join(__dirname,"../template/"+t+"/controllers/*"),"controllers/");var c=require("../template/"+t+"/shared");c.forEach(function(t){e.cp("-R",path.join(__dirname,"../template/shared/controllers/"+t+"Controller.js"),"controllers/"),e.cp("-R",path.join(__dirname,"../template/shared/models/"+t+".js"),"models/")}),e.mkdir("-p","tmp");var s={start:"node ./bin/www",reset:"rimraf ./tmp/*",test:"",build:"",postinstall:"turbo postinstall"},p={name:t,version:"0.0.0",server:!1,private:!0,scripts:s,dependencies:{turbo360:TURBO_NPM_VERSION,vertex360:VERTEX_NPM_VERSION,accepts:"^1.3.5","content-type":"^1.0.4",cookie:"0.3.1","cookie-signature":"1.0.6",depd:"^1.1.2","escape-html":"^1.0.3",express:"^4.17.1",finalhandler:"1.1.1",fresh:"0.5.2","merge-descriptors":"1.0.1",methods:"^1.1.2","on-finished":"^2.3.0",parseurl:"^1.3.2","path-to-regexp":"0.1.7","proxy-addr":"^2.0.3",qs:"6.5.1","range-parser":"^1.2.0","safe-buffer":"5.1.1",send:"0.16.2","serve-static":"1.13.2",setprototypeof:"1.1.0",statuses:"^1.4.0","type-is":"^1.6.16","utils-merge":"1.0.1",vary:"^1.1.2"},devDependencies:{nodemon:"^2.0.1",rimraf:"^2.6.2"},format:"vertex"};return utils.write("package.json",JSON.stringify(p,null,2)+"\n"),void utils.readFile("README.md").then(function(e){return null!=e&&(e=e.replace("{{title}}",t),utils.write("README.md",e+"\n")),utils.readFile(".env")}).then(function(e){null!=e&&(e=e.replace("{{TURBO_APP_ID}}",i.siteId),e=e.replace("{{TURBO_APP_SLUG}}",i.slug),e=e.replace("{{TURBO_API_KEY}}",i.apiKey),e=e.replace("{{slug}}",i.slug),utils.write(".env",e+"\n")),nextSteps(i.slug)}).catch(function(e){console.log("ERR: "+e.message)})}};