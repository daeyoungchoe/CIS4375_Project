var fs=require("fs"),os=require("os"),base64=require("js-base64"),superagent=require("superagent"),path=require("path"),readdirp=require("readdirp"),crossZip=require("cross-zip"),bestzip=require("bestzip"),shell=require("shelljs"),auth=require("../auth"),utils=require("../utils"),awsClient=require("../aws"),zipDirectory=function(){return"win32"==process.platform?bestzip.nodeZip({source:"*",destination:"../package.zip"}):new Promise(function(e,n){shell.exec("zip -r -q package.zip *"),e(!0)})};module.exports={deployVectors:function(e,n){return new Promise(function(n,o){if(0==auth.isLoggedIn())return void o(new Error("\nPlease Log In to Deploy Functions:\n$ turbo login\n"));var t={py:"python3",js:"node"},r=null,l=e.py?"py":"js",i=t[l],s=null,c=null;auth.currentUser().then(function(e){return r=e,utils.readFile("package.json")}).then(function(e){return s=JSON.parse(e),null==s.app?void o(new Error("Missing App ID")):awsClient.deployConfig({app:s.app,env:"dev"})}).then(function(e){if(c=e.app,c.profile.id!=r.id){for(var n=!1,t=0;t<c.collaborators.length;t++){if(c.collaborators[t].id==r.id){n=!0;break}}if(0==n)return void o(new Error("\nYou must be the admin or a collaborator to deploy this project. To login:\n$ turbo login\n"))}var p="vectors";0==fs.existsSync("vectors/js/index.js")&&(p="functions"),shell.mkdir("-p",p+"/_deploy"),"py"==l?(shell.cp("-R",p+"/py/*",p+"/_deploy/"),shell.cp("-R",path.join(__dirname,"../default/lambda/py/handler.py"),p+"/_deploy/"),shell.cd(p),shell.cd("_deploy"),shell.exec("pip install -r requirements.txt --target .")):(s.functions&&(s.dependencies=s.functions),delete s.functions,delete s.devDependencies,delete s.scripts,utils.write("./"+p+"/_deploy/package.json",JSON.stringify(s,null,2)+"\n"),shell.cd(p),shell.cp("-R","js/*","_deploy/"),shell.cp("-R",path.join(__dirname,"../default/lambda/js/handler.js"),"_deploy/"),shell.cd("_deploy"),shell.exec("npm install")),"win32"==process.platform?(crossZip.zipSync(".","../functions.zip"),shell.cd(".."),shell.mv(["functions.zip"],"_deploy/"),shell.cd("_deploy")):shell.exec("zip -r functions.zip *"),shell.mkdir("-p","pkg"),shell.mv(["functions.zip"],"pkg/"),shell.cd("pkg");var u=e.deploy,a=u.split("::"),d=awsClient.s3sync(null,{key:a[0],secret:a[1],bucket:"turbo360-functions",concurrency:16,prefix:c.slug+"/"}).on("data",function(e){console.log("Uploading ... "+e.fullPath)}).on("error",function(e){console.log("S3 sync error"+e)}).once("end",function(){console.log("Vectors uploaded.");var e="js"==l?"handler.main":"handler.trigger",n={config:u,name:c.slug,path:c.slug+"/functions.zip",runtime:i,handler:e};awsClient.getFunction(n).then(function(e){return null==e?null:awsClient.deleteFunction(n)}).then(function(e){return awsClient.deployFunction(n)}).then(function(e){console.log("\nVectors Deployed!\nTo test, visit\nhttps://production.turbo360-vector.com/"+e.FunctionName+"/[VECTOR_NAME]\n"),shell.cd(".."),shell.cd(".."),shell.rm("-rf","_deploy");var n={update:{site:{id:c.id,name:c.name,image:c.image,slug:c.slug,format:"vector"},description:"Deployed vectors",profile:r}};utils.postRequest("https://production.turbo360-vector.com/turbo-bohpvv/updateFunctions",n).then(function(e){}).catch(function(e){})}).catch(function(e){if(null==e.FunctionName)return void console.log("Error: "+e);console.log("\nVectors Deployed!\nTo test, visit\nhttps://production.turbo360-vector.com/"+e.FunctionName+"/[VECTOR_NAME]\n"),shell.cd(".."),shell.cd(".."),shell.rm("-rf","_deploy");var n={update:{site:{id:c.id,name:c.name,image:c.image,slug:c.slug,format:"vector"},description:"Deployed vectors",profile:r}};utils.postRequest("https://production.turbo360-vector.com/turbo-bohpvv/updateFunctions",n).then(function(e){}).catch(function(e){})})});readdirp({root:""}).pipe(d)}).catch(function(e){console.log("ERROR: "+e),o(e)})})}};